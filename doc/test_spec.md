# MCPサーバーテスト仕様書

## 1. 概要

このドキュメントは、`spec.md` に基づくMCPサーバーのテストの概要を説明します。すべてのテストは `pytest` フレームワークを使用して実装されます。

## 2. 単体テスト

### 2.1. PDFローダー (`test_pdf_loader.py`)

- **`test_find_pdfs`**:
  - **目的**: PDFローダーがディレクトリ内のすべての `.pdf` ファイル、およびサブディレクトリ内のPDFファイルを見つけられることを検証する。
  - **セットアップ**: PDFファイルと非PDFファイルを混在させた一時ディレクトリを作成し、サブディレクトリにもPDFファイルを配置する。
  - **アサーション**: 見つかったファイルのリストに、すべてのPDFファイルへのパスが含まれていることをアサートする。

- **`test_extract_text_from_pdf`**:
  - **目的**: PDFファイルからテキストが正しく抽出されることを検証する。
  - **セットアップ**: 既知のテキストコンテンツを持つシンプルなPDFファイルを作成する。
  - **アサーション**: 抽出されたテキストが期待されるコンテンツと一致することをアサートする。

### 2.2. MCPサーバー統合 (`test_mcp_client.py`)

- **`test_server_exposes_pdf_resources`**:
  - **目的**: MCPサーバーがPDFリソースを正しく公開していることを検証する。
  - **セットアップ**:
    1. MCPサーバーをバックグラウンドで起動する。
    2. テスト用のPDFファイルをサーバーが参照するディレクトリに配置する（サブディレクトリを含む）。
    3. FastMCPクライアントを初期化し、サーバーに接続する。
  - **アサーション**:
    - クライアントが特定のPDFリソース（例: `pdf://test_document.pdf`、`pdf://subdir/sub_document.pdf`）を読み取れることをアサートする。
    - 読み取ったコンテンツが期待されるPDFの内容と一致することをアサートする。

- **`test_server_handles_non_existent_resource`**:
  - **目的**: 存在しないリソースのリクエストをサーバーが正しく処理できることを検証する。
  - **セットアップ**:
    1. MCPサーバーをバックグラウンドで起動する。
    2. FastMCPクライアントを初期化し、サーバーに接続する。
  - **アサーション**:
    - 存在しないリソース（例: `pdf://non_existent.pdf`）を読み取ろうとしたときに、適切な応答（例: `None` または空のコンテンツ）が返されることをアサートする。

### 2.3. 認証 (`test_mcp_client.py`)

- **`test_server_requires_authentication`**:
  - **目的**: 認証トークンなしでリソースにアクセスしようとすると、サーバーがエラーを返すことを検証する。
  - **セットアップ**:
    1. MCPサーバーをバックグラウンドで起動する。
    2. FastMCPクライアントを初期化し、サーバーに接続する。
  - **アサーション**: 認証トークンなしでリソースを読み取ろうとしたときに、`McpError` が発生することをアサートする。

- **`test_server_authenticates_with_valid_token`**:
  - **目的**: 有効な認証トークンを使用してリソースにアクセスできることを検証する。
  - **セットアップ**:
    1. MCPサーバーをバックグラウンドで起動する。
    2. FastMCPクライアントを初期化し、有効な認証トークンを設定してサーバーに接続する。
  - **アサーション**: リソースを正常に読み取れることをアサートする。

- **`test_server_rejects_invalid_token`**:
  - **目的**: 無効な認証トークンを使用してリソースにアクセスしようとすると、サーバーがエラーを返すことを検証する。
  - **セットアップ**:
    1. MCPサーバーをバックグラウンドで起動する。
    2. FastMCPクライアントを初期化し、無効な認証トークンを設定してサーバーに接続する。
  - **アサーション**: `McpError` が発生することをアサートする。

- `pytest` 環境がセットアップされます。
- `requirements.txt` には `pytest`、`fastmcp`、`pdfplumber` が含まれます。
- テストは `pytest` コマンドで実行可能です。